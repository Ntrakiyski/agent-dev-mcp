version: "3.8"

services:
  chrome-mcp:
    build: .
    container_name: chrome-mcp-server
    ports:
      - "8000:8000"
    restart: unless-stopped
    
    # CRITICAL: IPC host mode prevents Chromium memory crashes
    # Without this, Chrome will fail with shared memory errors
    ipc: host
    
    # CRITICAL: Init mode prevents zombie processes
    # Playwright spawns multiple processes that need proper management
    init: true
    
    # CRITICAL: Shared memory size for Chromium
    # Alternative to ipc:host if platform restricts it
    shm_size: '2gb'
    
    environment:
      - PYTHONUNBUFFERED=1
    
    # Resource limits - Chromium needs minimum 2GB RAM
    deploy:
      resources:
        limits:
          memory: 2048M  # Minimum 2GB for Playwright + Chromium
          cpus: '2.0'    # 2 CPUs for better performance
        reservations:
          memory: 1024M  # Reserve 1GB minimum
